// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  avatar        String?
  isActive      Boolean   @default(true)
  isVerified    Boolean   @default(false)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  sessions      WaSession[]
  apiKeys       ApiKey[]
  refreshTokens RefreshToken[]

  @@index([email])
  @@index([isActive])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  revokedAt DateTime?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ============================================
// API KEY MANAGEMENT
// ============================================

model ApiKey {
  id          String    @id @default(cuid())
  name        String
  key         String    @unique
  keyHash     String    // Hashed version for security
  userId      String
  permissions String[]  @default(["read", "write"])
  isActive    Boolean   @default(true)
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([key])
  @@index([keyHash])
  @@index([userId])
  @@index([isActive])
  @@map("api_keys")
}

// ============================================
// WHATSAPP SESSION MANAGEMENT
// ============================================

enum SessionStatus {
  INITIALIZING
  QR_READY
  AUTHENTICATING
  CONNECTED
  DISCONNECTED
  FAILED
  LOGGED_OUT
}

model WaSession {
  id              String        @id @default(cuid())
  name            String
  description     String?
  userId          String
  status          SessionStatus @default(INITIALIZING)
  phoneNumber     String?
  pushName        String?       // WhatsApp display name
  profilePicUrl   String?
  qrCode          String?       // Current QR code (temporary)
  lastQrAt        DateTime?
  connectedAt     DateTime?
  disconnectedAt  DateTime?
  isActive        Boolean       @default(true)
  
  // ========================================
  // Session Configuration (previously nested in metadata.config)
  // ========================================
  
  // Debug mode
  debug           Boolean       @default(false)
  
  // Client configuration - how session appears in WhatsApp
  deviceName      String?       // e.g., "Windows", "macOS", "Ubuntu"
  browserName     String?       // e.g., "Chrome", "Firefox", "Safari"
  
  // Proxy configuration
  proxyServer     String?       // Proxy server address (e.g., "http://proxy:8080")
  proxyUsername   String?       // Proxy authentication username
  proxyPassword   String?       // Proxy authentication password
  
  // Event ignore configuration
  ignoreStatus    Boolean       @default(false)  // Ignore status@broadcast (stories)
  ignoreGroups    Boolean       @default(false)  // Ignore group events
  ignoreChannels  Boolean       @default(false)  // Ignore channel events
  ignoreBroadcast Boolean       @default(false)  // Ignore broadcast events
  
  // NOWEB engine configuration
  nowebStoreEnabled   Boolean   @default(true)   // Enable store for contacts, chats, messages
  nowebFullSync       Boolean   @default(false)  // Full sync on session initialization
  nowebMarkOnline     Boolean   @default(true)   // Mark as online when connected
  
  // User custom metadata (key-value pairs included in webhooks)
  metadata        Json?         // Only for user-defined custom data
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  webhooks        Webhook[]
  messages        Message[]
  contacts        Contact[]
  chats           Chat[]

  @@unique([userId, name])
  @@index([userId])
  @@index([status])
  @@index([isActive])
  @@map("wa_sessions")
}

// ============================================
// WEBHOOK MANAGEMENT
// ============================================

enum WebhookEvent {
  // WAHA-style events (preferred)
  message           // Any incoming message
  message_any       // All messages (sent and received)
  message_ack       // Message delivery/read status
  message_reaction  // Reactions to messages
  message_revoked   // Deleted/revoked messages
  message_edited    // Edited messages
  message_waiting   // Messages waiting to be sent
  session_status    // Session status changes
  group_join        // Someone joined a group
  group_leave       // Someone left a group
  group_update      // Group info updated
  presence_update   // Online/typing status updates
  poll_vote         // Poll vote received
  poll_vote_failed  // Poll vote failed
  call_received     // Incoming call
  call_accepted     // Call accepted
  call_rejected     // Call rejected
  label_upsert      // Label created/updated
  label_deleted     // Label deleted
  label_chat_added  // Chat added to label
  label_chat_deleted // Chat removed from label
  contact_update    // Contact info updated
  chat_archive      // Chat archived/unarchived
  
  // Legacy events (backward compatibility)
  MESSAGE_RECEIVED
  MESSAGE_SENT
  MESSAGE_ACK
  MESSAGE_REVOKED
  QR_RECEIVED
  AUTHENTICATED
  AUTH_FAILURE
  READY
  DISCONNECTED
  STATE_CHANGE
  CONTACT_CHANGED
  GROUP_JOIN
  GROUP_LEAVE
  GROUP_UPDATE
  CALL_RECEIVED
  
  // Wildcard
  ALL
}

model Webhook {
  id              String         @id @default(cuid())
  name            String
  url             String
  sessionId       String
  events          WebhookEvent[] // No default - will be expanded to all events by service layer
  
  // Security
  secret          String?        // HMAC secret for signature verification
  
  // Custom headers (key-value pairs to send with webhook)
  customHeaders   Json?          // { "X-Custom-Header": "value", ... }
  
  // Retry configuration - dedicated columns for better querying
  retryAttempts   Int            @default(3)      // Number of retry attempts (0-15)
  retryDelay      Int            @default(2)      // Delay between retries in seconds
  retryPolicy     String         @default("linear") // linear, exponential, constant
  
  // Request configuration
  timeout         Int            @default(30000)  // Request timeout in milliseconds
  
  // Status
  isActive        Boolean        @default(true)
  
  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  session         WaSession      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  logs            WebhookLog[]

  @@index([sessionId])
  @@index([isActive])
  @@map("webhooks")
}

model WebhookLog {
  id          String   @id @default(cuid())
  webhookId   String
  event       String
  payload     Json
  statusCode  Int?
  response    String?
  error       String?
  duration    Int?     // ms
  attempts    Int      @default(1)
  success     Boolean
  createdAt   DateTime @default(now())

  // Relations
  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([createdAt])
  @@index([success])
  @@map("webhook_logs")
}

// ============================================
// MESSAGE MANAGEMENT
// ============================================

enum MessageDirection {
  INCOMING
  OUTGOING
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  STICKER
  LOCATION
  CONTACT
  POLL
  REACTION
  SYSTEM
  UNKNOWN
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
  REVOKED
}

model Message {
  id              String           @id @default(cuid())
  waMessageId     String           // WhatsApp message ID
  sessionId       String
  chatId          String
  direction       MessageDirection
  type            MessageType      @default(TEXT)
  body            String?
  caption         String?
  mediaUrl        String?
  mediaType       String?
  mediaMimeType   String?
  mediaFilename   String?
  mediaSize       Int?
  quotedMessageId String?
  mentionedIds    String[]         @default([])
  isForwarded     Boolean          @default(false)
  isFromMe        Boolean          @default(false)
  status          MessageStatus    @default(PENDING)
  timestamp       DateTime
  ackAt           DateTime?
  metadata        Json?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  session     WaSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  chat        Chat      @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@unique([sessionId, waMessageId])
  @@index([sessionId])
  @@index([chatId])
  @@index([timestamp])
  @@index([direction])
  @@map("messages")
}

// ============================================
// CHAT & CONTACT MANAGEMENT
// ============================================

enum ChatType {
  PRIVATE
  GROUP
  BROADCAST
}

model Chat {
  id            String    @id @default(cuid())
  waChatId      String    // WhatsApp chat ID (e.g., 628xxx@c.us)
  sessionId     String
  type          ChatType  @default(PRIVATE)
  name          String?
  isGroup       Boolean   @default(false)
  isMuted       Boolean   @default(false)
  isPinned      Boolean   @default(false)
  isArchived    Boolean   @default(false)
  unreadCount   Int       @default(0)
  lastMessageAt DateTime?
  metadata      Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  session  WaSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  messages Message[]

  @@unique([sessionId, waChatId])
  @@index([sessionId])
  @@index([type])
  @@map("chats")
}

model Contact {
  id            String   @id @default(cuid())
  waContactId   String   // WhatsApp contact ID
  sessionId     String
  name          String?
  pushName      String?  // WhatsApp display name
  shortName     String?
  number        String?
  isMyContact   Boolean  @default(false)
  isBlocked     Boolean  @default(false)
  isBusiness    Boolean  @default(false)
  profilePicUrl String?
  about         String?
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  session WaSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, waContactId])
  @@index([sessionId])
  @@index([number])
  @@map("contacts")
}

// ============================================
// AUDIT & LOGGING
// ============================================

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  oldData   Json?
  newData   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}
